<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="d3/d3.js"></script>
    <title>Bar Chart</title>
</head>
<body onload='init()'>
<script>
    async function init() {
        const cacounties = await d3.csv('ca_counties.csv', d3.autoType);
        const bloomdata = await d3.csv('fhab_bloomreport.csv', d3.autoType);

        //Width and height
        var w = 760;
        var h = 600;
        var margin = 80;

        var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);
        var g = svg.append('g').attr('id', 'barchartcontainer')
            .attr('transform', 'translate('+margin+','+margin+')');
        var countbyID = d3.nest()
            .key(function(d) {return cacounties[d.CountyID-1].countyName;})
            .rollup(function(v) {return v.length;})
            .entries(bloomdata)
            .sort(function(a, b){ return d3.descending(a.value, b.value); });
        var listCountyName = []
        for (var i = 0; i < countbyID.length; i++) {
            listCountyName.push(countbyID[i].key);
        }

        var xs = d3.scaleBand().domain(listCountyName).range([0, w-2*margin]);
        var ys = d3.scaleLinear().domain([0, 100]).range([h-2*margin, 0]);
        g.selectAll('rect').data(countbyID).enter().append('rect')
            .attr('x', function (d) {
                return xs(d.key);
            })
            .attr('y', function (d) {
                return ys(d.value);
            })
            .attr('width', xs.bandwidth())
            .attr('height', function (d) {return h-2*margin-ys(d.value);});
        d3.select('svg').append('g')
            .attr('transform', 'translate('+margin+','+margin+')')
            .call(d3.axisLeft(ys));
        d3.select('svg').append('g')
            .attr('transform', 'translate('+margin+','+(h-margin)+')')
            .call(d3.axisBottom(xs))
            .selectAll("text")
            .attr("y", 0)
            .attr("x", -9)
            .attr("dy", ".35em")
            .attr("transform", "rotate(270)")
            .style("text-anchor", "end");
    };


</script>
</body>
</html>
